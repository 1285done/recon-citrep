{%include "headers.njk"%}
<style>
	.resultrow {
		cursor: pointer;
	}

	.table-responsive {
		overflow-x: hidden;
	}

	.moon-hidden {
		display: none;
	}
</style>

<body>
	{%include "navbar.njk"%} {%if user.role.numeric > 0%}
	<div class="container">
		<div class="row">
			<button class="btn btn-primary my-2" data-toggle="modal" data-target="#search" accesskey="s">Search</button>
			<div role="dialog" tabindex="-1" class="modal fade" id="search">
				<div class="modal-dialog modal-lg" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h4 class="modal-title">Structure Search</h4>
							<button type="button" class="close " data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">x</span>
							</button>
						</div>
						<div class="modal-body">
							<form action='/search' method='post'>
								<div class="row">
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="system">System:</label>
											<input type="text" id="system" name="system" class="form-control">
										</div>
									</div>
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="region">Region:</label>
											<input type="text" id="region" name="region" class="form-control">
										</div>
									</div>
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="constellation">Constellation:</label>
											<input type="text" id="constellation" name="constellation" class="form-control">
										</div>
									</div>
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="citname">Name:</label>
											<input type='text' name='citname' class="form-control" id="citname">
										</div>
									</div>
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="cittype">Type:</label>
											<select name='type' class="form-control" id="cittype">
												<option value="All">All</option>
												<option value="Astrahus">Astrahus</option>
												<option value="Fortizar">Fortizar</option>
												<option value="Faction_Fortizar">Faction Fortizar</option>
												<option value="Keepstar">Keepstar</option>
												<option value="Athanor">Athanor</option>
												<option value="Tatara">Tatara</option>
												<option value="Raitaru">Raitaru</option>
												<option value="Azbel">Azbel</option>
												<option value="Sotyio">Sotyio</option>
											</select>
										</div>
									</div>
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="corp">Corp:</label>
											<input type='text' name='corp' class="form-control" id="corp">
										</div>
									</div>
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="alliance">Alliance:</label>
											<input type='text' name='alliance' class="form-control" id="alliance">
										</div>
									</div>
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="power">Power: </label>
											<select name='power' class="form-control" id="power">
												<option value="Any">Any</option>
												<option value="High">High</option>
												<option value="Low">Low</option>
											</select>
										</div>
									</div>
									<!--<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="fit">Fitting: </label>
											<input type='text' name='fit' class="form-control" id="fit">
										</div>
									</div>
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="moondata">Moon Data: </label>
											<select name='moondata' class="form-control" id="moondata">
												<option value="Any">Any</option>
												<option value="None">None</option>
												<option value="R4">R4</option>
												<option value="R8">R8</option>
												<option value="R16">R16</option>
												<option value="R32">R32</option>
												<option value="R64">R64</option>
												<option value="Double R64">Double R64</option>

											</select>
										</div>
									</div>-->

									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="vulnhourmin">Vuln Hour Min:</label>
											<select name='vulnhourmin' class="form-control" id="vulnhourmin">
												<option value=""></option>
												{%for i in range(0, 24)%}
												<option value="{{i}}">{{i}}:00</option>
												{%endfor%}
											</select>
										</div>
									</div>
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="vulnhourmax">Vuln Hour Max:</label>
											<select name='vulnhourmax' class="form-control" id="vulnhourmax">
												<option value=""></option>
												{%for i in range(0, 24)%}
												<option value="{{i}}">{{i}}:00</option>
												{%endfor%}
											</select>

										</div>
									</div>
									<div class="col col-lg-6 col-md-6 col-sm-12">
										<div class="form-group">
											<label for="vulnday">Vuln Day:</label>
											<select name='vulnday' class="form-control" id="vulnday">
												<option value=""></option>
												<option value="Sunday">Sunday</option>
												<option value="Monday">Monday</option>
												<option value="Tuesday">Tuesday</option>
												<option value="Wednesday">Wednesday</option>
												<option value="Thursday">Thursday</option>
												<option value="Friday">Friday</option>
												<option value="Saturday">Saturday</option>
											</select>
										</div>
									</div>
									<div class="col col-lg-3 col-md-6 col-sm-12">
										<div class="form-group">
											<input type='submit' value='Submit' class="btn btn-success">
											<input type='reset' value='Reset' class="btn btn-danger">
										</div>
									</div>

								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
			<div class="table-responsive">
				<table id="resultTable" class="table table-striped table-hover table-sm table-fixed">
					<thead>
						<tr>
							<th>Region:</th>
							<th>System:</th>
							<th>Type:</th>
							<th>Name:</th>
							<th>Corp:</th>
							<th>Alliance:</th>
						</tr>
					</thead>
					<tbody>
						{% for citadel in results %}
						<tr class='resultrow' onclick="openCitadelInfo('{{citadel._id}}')">
							<td>{{ citadel.region }}</td>
							<td>{{ citadel.system }}</td>
							<td>{{ citadel.type }}</td>
							<td>{{ citadel.citname }}</td>
							<td>{{ citadel.corp }}</td>
							<td>{{ citadel.alliance }}</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
	{%endif%}
</body>


<div role="dialog" tabindex="-1" class="modal fade" id="detailview">
	<div class="modal-dialog modal-lg modal-dialog-centered" role="document">
		<div class="modal-content">
			<div>

				<div class="modal-header bg-dark text-light">
					<h4 class="modal-title">
						<i class=""></i>Citadel Details</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">Ã—</span>
					</button>
				</div>
				<ul class="nav nav-tabs">
					<li class="nav-item">
						<a role="tab" data-toggle="tab" href="#basic-tab" class="nav-link active">Basic Info</a>
					</li>
					<li class="nav-item">
						<a role="tab" data-toggle="tab" href="#fitting-tab" class="nav-link">Fitting</a>
					</li>
					<li class="nav-item">
						<a role="tab" id="moontabtab" data-toggle="tab" href="#moon-tab" class="nav-link">Moongoo</a>
					</li>
				</ul>
				<div class="modal-body">
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active" id="basic-tab">
							<form id="modalform" action="/update" method="post">
								<div class="row">
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<label for="modalname">Name:</label>
											<!--<p id='modalname'></p>-->
											<input id="modalname" name="modalname" class="form-control" type="text" {%if user.role.numeric < 2%}readonly{%endif%}>
										</div>
									</div>
									
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<label for="modalcorp">Corp:</label>
											<input id="modalcorp" name="modalcorp" class="form-control" type="text" {%if user.role.numeric < 2%}readonly{%endif%}>
										</div>
									</div>
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<label for="modalalliance">Alliance:</label>
											<input id="modalalliance" name="modalalliance" class="form-control" type="text" {%if user.role.numeric < 2%}readonly{%endif%}>
										</div>
									</div>
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<label for="modalsystem">System:</label>
											<input id="modalsystem" name="modalsystem" class="form-control" type="text" {%if user.role.numeric < 2%}readonly{%endif%}>
										</div>
									</div>
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<label for="modalregion">Region:</label>
											<input id="modalregion" name="modalregion" class="form-control" type="text" {%if user.role.numeric < 2%}readonly{%endif%}>
										</div>
									</div>
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<label for="modalconstellation">Constallation:</label>
											<input id="modalconstellation" name="modalconstellation" class="form-control" type="text" {%if user.role.numeric < 2%}readonly{%endif%}>
										</div>
									</div>
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<label for="modaltype">Type:</label>
											<input id="modaltype" name="modaltype" class="form-control" type="text" {%if user.role.numeric < 2%}readonly{%endif%}>
										</div>
									</div>
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<label for="modalpower">Power:</label>
											<input id="modalpower" name="modalpower" class="form-control" type="text" {%if user.role.numeric < 2%}readonly{%endif%}>
										</div>
									</div>
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<label for="modalvuln">Vulnerability:</label>
											<input id="modalvuln" name="modalvuln" class="form-control" type="text" {%if user.role.numeric < 2%}readonly{%endif%}>
										</div>
									</div>
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<label for="modalsubmitted">Date Submitted:</label>
											<input id="modalsubmitted" name="modalsubmitted" class="form-control" type="text" readonly>
										</div>
									</div>
									<div class="col-lg-4 col-md-6">
									<div class="form-group">
									<label for="modalid">ID:</label>
									<input id="modalid" name="modalid" class="form-control" type="text" readonly>
									</div>
									</div>
									{%if user.role.numeric > 2%}
									<div class="col-lg-4 col-md-6">
										<div class="form-group">
											<input type='submit' value='Update' class="btn btn-success">
										</div>
									</div>
									{%endif%}
								</div>
							</form>
						</div>
						<div role="tabpanel" class="tab-pane" id="fitting-tab">
						
							<p>High Slots:</p>
							<div class="table-responsive">
							<table id="hightable" class = "table table-striped table-hover table-sm">
								<tbody id="high">
								</tbody>
							</table>
							</div>
							<p>Mid Slots:</p>
							<div class="table-responsive">
							<table id="midtable" class = "table table-striped table-hover table-sm">
								<tbody id="mid">
								</tbody>
							</table>
							</div>
							<p>Low Slots:</p>
							<div class="table-responsive">
							<table id="lowtable" class = "table table-striped table-hover table-sm">
								<tbody id="low">
								</tbody>
							</table>
							</div>
							<p>Rigs:</p>
							<div class="table-responsive">
							<table id="rigtable" class = "table table-striped table-hover table-sm">
								<tbody id="rig">
								</tbody>
							</table>
							</div>
							<p>Services:</p>
							<div class="table-responsive">
							<table id="servicetable" class = "table table-striped table-hover table-sm">
								<tbody id="service">
								</tbody>
							</table>
							</div>
						</div>
						<div role="tabpanel" class="tab-pane" id="moon-tab">
							<label for="moondata">Moon Composition:</label>
							<table id="servicetable" class = "table table-striped table-hover table-sm">
								<tbody id="moondata">
								</tbody>
							</table>
							<p>Value for 56d frack (Value may be extremely inaccurate due to lack of ore in jita):</p>
							<span id="moonvalue"></span>
							<!-- Estimated value -->
						</div>
					</div>

				</div>
			</div>
		</div>
	</div>
	<!-- TODO: Obfuscate?-->
	<script>
		$(document).ready(function () {
			$('#modalform').ajaxForm();
			$('#resultTable').DataTable({
				"pagingType": "simple_numbers",
				"searching": false,
				"sorting": false
			})
			$('.dataTables_length').addClass('bs-select');
		})
	$('#modalform').submit(function () {
		$(this).ajaxSubmit(function(res){
			if(res == "success"){
				location.reload()
			}else{
				alert("There was an error updating this citadel")
			}
		});
		$('#detailview').modal('hide');
		//return false;

	})

	function openCitadelInfo(id) {
		$.ajax({
			url: "/citadel/" + id,
			type: "POST",
			data: ""
		}).done(function (response) {
			console.log(response)
			$('#detailview').modal('toggle');
			$('#modalname').val(response.citname)
			$('#modaltype').val(response.type)
			$('#modalalliance').val(response.alliance)
			$('#modalcorp').val(response.corp)
			$('#modalregion').val(response.region)
			$('#modalconstellation').val(response.constellation)
			$('#modalsystem').val(response.system)
			$('#modalpower').val(response.power)
			$('#modalmoondata').val(response.moondata)
			$('#modalid').val(id)
			if (response.type == "Athanor" || response.type == "Tatara") {
				$('#moontabtab').removeClass('moon-hidden')
				var moongoo = "";
				for (var i = 0; i < response.moondata.length; i++) {
					console.log(i)
					moongoo += "<tr><td><img src='https://image.eveonline.com/Type/"+response.moondata[i].id+"_32.png'/></td><td>"+ response.moondata[i].ore + "</td><td>" + parseFloat(response.moondata[i].amount * 100).toFixed(2) +
						"%</td>"
				}
				$('#moondata').html(moongoo)
				getDataString(response.moondata)
			} else {
				$('#moontabtab').addClass('moon-hidden')
			}

			console.log()
			var highstring = ""
			var midstring = ""
			var lowstring = ""
			var rigstring = ""
			var servicestring = ""
			var counter = 0;
			var func = function (){
				var arr = generateIDs(response.fit)
				var dfd = $.Deferred();
				for(var promise of arr){
				//console.log(promise)
				switch(promise.slot){
					case "high":
					var object = promise.promise.id().done(function(data){
						highstring += "<tr><td><img src='https://image.eveonline.com/Type/"+data.typeID+"_32.png'/></td><td>" + data.typeName + "</td></tr>"
						//console.log(highstring)
						counter++
						if(counter == arr.length){
					dfd.resolve();
				}
					})
					break;
					case "mid":
					var object = promise.promise.id().done(function(data){
						midstring += "<tr><td><img src='https://image.eveonline.com/Type/"+data.typeID+"_32.png'/></td><td>" + data.typeName + "</td></tr>"
						//console.log(midstring)
						counter++
						if(counter == arr.length){
					dfd.resolve();
				}
					})
					break;
					case "low":
					var object = promise.promise.id().done(function(data){
						lowstring += "<tr><td><img src='https://image.eveonline.com/Type/"+data.typeID+"_32.png'/></td><td>" + data.typeName + "</td></tr>"
						//console.log(lowstring)
						counter++
						if(counter == arr.length){
					dfd.resolve();
				}
					})
					break;
					case "rig":
					var object = promise.promise.id().done(function(data){
						rigstring += "<tr><td><img src='https://image.eveonline.com/Type/"+data.typeID+"_32.png'/></td><td>" + data.typeName + "</td></tr>"
						//console.log(rigstring)
						counter++
						if(counter == arr.length){
					dfd.resolve();
				}
					})
					break;
					case "service":
					var object = promise.promise.id().done(function(data){
						servicestring += "<tr><td><img src='https://image.eveonline.com/Type/"+data.typeID+"_32.png'/></td><td>" + data.typeName + "</td></tr>"
						//console.log(servicestring)
						counter++
						if(counter == arr.length){
					dfd.resolve();
				}
					})
					break;
				}
				//console.log(counter)
				
			}
			return dfd.promise();
			}


			$.when(func()).then(function(){
				console.log("boop")
				$(`#high`).html(highstring)
				$(`#mid`).html(midstring)
				$(`#low`).html(lowstring)
				$(`#rig`).html(rigstring)
				$(`#service`).html(servicestring)
			})
			/*
			for (var property in response.fit) {
				if (response.fit.hasOwnProperty(property)) {
					var string = ""
					var counter = 0;
					response.fit[property].forEach(slot => {
						var fuzzworkTypeid = {
							id: function () {
								return $.ajax(`http://www.fuzzwork.co.uk/api/typeid.php?typename=${slot}`).then(function (data) {
									return JSON.parse(data).typeID;
								})
							}
						}
						fuzzworkTypeid.id().done(function (id) {
							string += "<tr><td>" + id + "</td><td>" + slot + "</td></tr>"
							counter++
							if (counter == response.fit[property].length) {
								console.log(`${property}`)
								console.log(string)
								
								counter = 0;
								string = ""
							}
						})




					})
				}
			}*/
			if (!!response.vulnerability.day || !!response.vulnerability.hour) {
				$('#modalvuln').val(response.vulnerability.day + " " + response.vulnerability.hour + ":00")
			} else {
				$('#modalvuln').val("No data")
			}

			$('#modalsubmitted').val(response.lastSubmittedDate)
		});
	}

	function generateIDs(fit) {
		var promiseArr = []
		for (var property in fit) {
			if (fit.hasOwnProperty(property)) {
				fit[property].forEach(slot => {
					var fuzzworkTypeid = {
						id: function () {
							return $.ajax(`https://www.fuzzwork.co.uk/api/typeid.php?typename=${slot}`).then(function (data) {
								return JSON.parse(data);
							})
						}
					}
					promiseArr.push({slot: property, promise: fuzzworkTypeid})
				})
			}
		}
		return promiseArr
	}


	function typenameToId(name) {
		$.ajax({
			url: `https://www.fuzzwork.co.uk/api/typeid.php?typename=${name}`,
			type: 'GET'
		}).done(function (res) {
			console.log(JSON.parse(res))
			console.log(JSON.parse(res).typeID)
			return JSON.parse(res).typeID
		})
	}

	//TODO: Get refined products instead of raw ore.
	function getDataString(moondata) {
		console.log(moondata)
		var volumeofore = 1344 * 20000; //56d * 20km3/h
		var arrayofores = []
		var datastring = ""
		var counter = 0;
		moondata.forEach(moon => {
			$.ajax({
				url: "https://esi.evetech.net/latest/universe/types/" + moon.id + "/?datasource=tranquility&language=en-us",
				type: "GET"
			}).done(function (response1) {
				arrayofores.push({
					ore: moon.ore,
					amount: parseFloat((parseFloat(moon.amount * volumeofore).toFixed(0)) / response1.volume).toFixed(0)
				});
				datastring += moon.ore + " " + parseFloat((parseFloat(moon.amount * volumeofore).toFixed(0)) / response1.volume)
					.toFixed(0) + "^"
				counter++
				if (counter == moondata.length) {
					getEvePraisal(datastring)
				}
			})



		})
		//return datastring
	}

	function getEvePraisal(data) {
		$.ajax({
			url: `/appraisal.json?market=jita&persist=no&raw_textarea=${data}`,
			method: "GET"
		}).done(function (evepraisal) {
			console.log(evepraisal)
			$("#moonvalue").html((evepraisal.appraisal.totals.sell).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + " isk")
		})
	}
	</script>